name: Build DenOS ISO

on:
  workflow_dispatch:  # allows manual trigger from GitHub Actions UI

jobs:
  build-iso:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write

    steps:
      # 1️⃣ Checkout the repository
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2️⃣ Install dependencies
      - name: Install required packages
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            debootstrap squashfs-tools xorriso grub-pc-bin grub-efi-amd64-bin grub-efi-ia32-bin \
            mtools dosfstools isolinux genisoimage

      # 3️⃣ Make all build scripts executable
      #- name: Make build scripts executable
      #  run: chmod +x ./*.sh

      # 4️⃣ Run all build scripts sequentially
      - name: Run DenOS build scripts
        run: |
          set -e
          scripts/01_denos_pre_reqs.sh
          scripts/02_denos_debootstrap.sh
          scripts/03_denos_chroot.sh || ./03_denos_chroot_lxde.sh || true
          scripts/04_denos_MakeSquashfs.sh
          scripts/05_denos_BiosUEFI_ISO.sh
          mkdir -p $GITHUB_WORKSPACE/output
          # Move final ISO (whatever its name) to output/
          find . -type f -name "*.iso" -exec mv {} $GITHUB_WORKSPACE/output/ \;

      # 5️⃣ List files to verify ISO exists
      - name: List output contents
        run: |
          echo "Listing contents of workspace..."
          ls -lhR $GITHUB_WORKSPACE/output || true

      # 6️⃣ Upload ISO as GitHub artifact
      - name: Upload DenOS ISO artifact
        uses: actions/upload-artifact@v4
        with:
          name: denos-iso
          path: ${{ github.workspace }}/output/*.iso
